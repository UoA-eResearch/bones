<!DOCTYPE html>
<html lang="en">

<head>
    <title>bones</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <style>
        body {
            background-color: #000;
            color: #fff;
            padding: 0;
            margin: 0;
            font-weight: bold;
            overflow: hidden;
            font-family: sans-serif;
            font-size: 12px;
            text-align: center;
        }

        #info {
            background-color: #000;
            position: absolute;
            width: 100%;
            top: 0px;
            padding: 5px;
            z-index: 999;
        }

        a {
            color: #0080ff;
        }

        b {
            color: orange
        }

        .label {
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 4px;
            border: 1px solid #fff;
            padding: 2px;
        }

        #measurements_table {
            position: absolute;
            z-index: 1000;
            top: 40px;
            right: 10px;
            background-color: black;
            border-radius: 4px;
            border: 1px solid #fff;
            padding: 2px;
        }
    </style>
</head>

<body>
    <div id="info">Controls: left mouse button to rotate, right mouse button to pan. Mouse wheel to zoom. Double click to focus</div>
    <div id="container"></div>
    <table id="measurements_table">
        <thead>
            <tr>
                <th>Measurement</th>
                <th>Value</th>
            </tr>
        </thead>
        <tbody id="measurements">
        </tbody>
    </table>
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/"
            }
        }
    </script>
    <script type="module">

        import $ from 'https://cdn.jsdelivr.net/npm/jquery@3.7.1/+esm'
        import * as THREE from 'three';
        import Stats from 'three/addons/libs/stats.module.js';
        import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';
        import WebGL from 'three/addons/capabilities/WebGL.js';
        import { ArcballControls } from 'three/addons/controls/ArcballControls.js';
        import papaparse from 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/+esm';
        import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';

        let container = document.getElementById('container')

        let stats;

        let camera, cameraTarget, scene, renderer, controls, labelRenderer;

        init();

        function addLabel(text, position) {
            const labelDiv = document.createElement('div');
            labelDiv.className = 'label';
            labelDiv.textContent = text;
            const label = new CSS2DObject(labelDiv);
            label.position.copy(position);
            scene.add(label);
        }

        function annotateLine(start, end, text) {
            const material = new THREE.LineBasicMaterial({ color: 0x0000ff });
            const geometry = new THREE.BufferGeometry().setFromPoints([start, end]);
            const line = new THREE.Line(geometry, material);
            scene.add(line);
            addLabel(text, new THREE.Vector3().addVectors(start, end).divideScalar(2));
        }

        papaparse.parse("example_landmarks.txt", {
            download: true,
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function (results) {
                console.log(results);
                var landmarks = {}
                for (var landmark of results.data) {
                    landmarks[landmark.Landmark] = new THREE.Vector3(landmark.x, landmark.y, landmark.z)
                    if (!landmark.Landmark.endsWith("_mid")) {
                        addLabel(landmark.Landmark, landmarks[landmark.Landmark])
                    }
                }

                papaparse.parse("measurements_example.txt", {
                    download: true,
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        var measurements = results.data[0]
                        console.log(measurements)
                        for (var key in measurements) {
                            if (key != "Case_name") {
                                $("#measurements").append(`<tr><td>${key}</td><td>${measurements[key].toLocaleString()}</td></tr>`)
                            }
                        }
                        annotateLine(landmarks.LASIS, landmarks.RASIS,`ASIS_width: ${measurements.ASIS_width.toLocaleString()}`);
                        annotateLine(landmarks.LPSIS, landmarks.RPSIS, `PSIS_width: ${measurements.PSIS_width.toLocaleString()}`);
                    }
                })
            }
        })

        function init() {

            if (!WebGL.isWebGLAvailable()) {
                const warning = WebGL.getWebGLErrorMessage();
                container.appendChild(warning);
                return;
            }

            camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.set(1000, 0, 0);

            scene = new THREE.Scene();

            const material = new THREE.MeshPhongMaterial({ color: 0xffffff, flatShading: false });

            const loader = new PLYLoader();
            for (var ply of ["Left_femur.ply", "Left_tibfib.ply", "Pelvis.ply", "Right_femur.ply", "Right_tibfib.ply"]) {
                loader.load(ply, function (geometry) {
                    geometry.computeVertexNormals(true);
                    const mesh = new THREE.Mesh(geometry, material);
                    scene.add(mesh);
                });
            }

            // lights

            const dirLight1 = new THREE.DirectionalLight(0xffffff, 3);
            dirLight1.position.set(1, 1, 1);
            scene.add(dirLight1);

            const dirLight2 = new THREE.DirectionalLight(0x002288, 3);
            dirLight2.position.set(-1, -1, -1);
            scene.add(dirLight2);

            const ambientLight = new THREE.AmbientLight(0x555555);
            scene.add(ambientLight);
            // renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setAnimationLoop(animate);
            renderer.shadowMap.enabled = true;
            container.appendChild(renderer.domElement);

            labelRenderer = new CSS2DRenderer();
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.domElement.style.position = 'absolute';
            labelRenderer.domElement.style.top = '0px';
            document.body.appendChild(labelRenderer.domElement);

            //controls
            controls = new ArcballControls(camera, labelRenderer.domElement, scene);
            controls.addEventListener('change', render);
            controls.setGizmosVisible(false);
            controls.minDistance = 1
            controls.maxDistance = 2000
            // axes
            //const axesHelper = new THREE.AxesHelper(250);
            //scene.add(axesHelper);
            // stats
            //stats = new Stats();
            //container.appendChild(stats.dom);
            window.addEventListener('resize', onWindowResize);
            window.addEventListener( 'keydown', onKeyDown );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            labelRenderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            render();
        }

        function render() {
            renderer.render(scene, camera);
            labelRenderer.render(scene, camera);
        }

        function onKeyDown(event) {
            if (event.key === 'c') {
                if (event.ctrlKey || event.metaKey) {
                    controls.copyState();
                }
            } else if (event.key === 'v') {
                if (event.ctrlKey || event.metaKey) {
                    controls.pasteState();
                }
            }
        }
    </script>
</body>

</html>